<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Book Library</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
    :root {
      --bg:#06090d; --surface:#0c1017; --card:#111820; --border:#1a2535;
      --accent:#00e5ff; --accent2:#6d28d9; --red:#ef4444;
      --text:#dde6f0; --muted:#4d6278; --glow:0 0 40px rgba(0,229,255,0.12);
    }
    html { scroll-behavior:smooth; }
    body { background:var(--bg); color:var(--text); font-family:'Syne',sans-serif; min-height:100vh; overflow-x:hidden; cursor:none; }
    body::before { content:''; position:fixed; inset:0; background-image:linear-gradient(rgba(0,229,255,0.025) 1px,transparent 1px),linear-gradient(90deg,rgba(0,229,255,0.025) 1px,transparent 1px); background-size:64px 64px; pointer-events:none; z-index:0; }

    /* CURSOR */
    .cursor { position:fixed; width:10px; height:10px; background:var(--accent); border-radius:50%; pointer-events:none; z-index:9999; mix-blend-mode:screen; transition:transform 0.08s; }
    .cursor-ring { position:fixed; width:34px; height:34px; border:1px solid var(--accent); border-radius:50%; pointer-events:none; z-index:9998; opacity:0.45; transition:width 0.18s,height 0.18s,border-color 0.18s; }

    /* LOADER */
    #loader { position:fixed; inset:0; z-index:500; background:var(--bg); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:1.2rem; }
    .ld-logo { font-family:'Space Mono',monospace; color:var(--accent); font-size:clamp(0.85rem,2vw,1rem); letter-spacing:0.1em; }
    .spinner { width:34px; height:34px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 0.75s linear infinite; }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* AUTH */
    #authWrap { position:fixed; inset:0; z-index:300; display:none; align-items:center; justify-content:center; background:var(--bg); padding:1rem; }
    .auth-card { background:var(--card); border:1px solid var(--border); border-radius:20px; padding:clamp(1.6rem,5vw,2.6rem); width:100%; max-width:440px; box-shadow:0 0 60px rgba(0,229,255,0.06); }
    .auth-logo { font-family:'Space Mono',monospace; color:var(--accent); font-size:0.82rem; margin-bottom:1.4rem; letter-spacing:0.1em; }
    .auth-h { font-size:clamp(1.4rem,4vw,1.8rem); font-weight:800; margin-bottom:0.4rem; }
    .auth-sub { color:var(--muted); font-size:clamp(0.78rem,2vw,0.86rem); margin-bottom:1.8rem; line-height:1.55; }
    .tabs { display:flex; border:1px solid var(--border); border-radius:8px; overflow:hidden; margin-bottom:1.8rem; }
    .tab { flex:1; padding:0.62rem; text-align:center; font-family:'Space Mono',monospace; font-size:clamp(0.62rem,1.5vw,0.72rem); letter-spacing:0.06em; cursor:none; background:transparent; border:none; color:var(--muted); transition:all 0.2s; }
    .tab.on { background:var(--accent); color:#06090d; font-weight:700; }
    .fg { margin-bottom:1rem; }
    .fg label { display:block; font-family:'Space Mono',monospace; font-size:clamp(0.6rem,1.4vw,0.67rem); letter-spacing:0.1em; color:var(--muted); margin-bottom:0.42rem; }
    .fg input { width:100%; padding:clamp(0.62rem,2vw,0.78rem) 1rem; background:var(--surface); border:1px solid var(--border); border-radius:8px; color:var(--text); font-family:'Syne',sans-serif; font-size:clamp(0.85rem,2vw,0.94rem); outline:none; transition:border-color 0.2s; cursor:none; }
    .fg input:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(0,229,255,0.07); }
    .btn-main { width:100%; padding:0.88rem; background:var(--accent); color:#06090d; border:none; border-radius:8px; font-family:'Space Mono',monospace; font-size:clamp(0.72rem,1.8vw,0.82rem); font-weight:700; letter-spacing:0.05em; cursor:none; transition:all 0.22s; margin-top:0.4rem; }
    .btn-main:hover { box-shadow:0 0 32px rgba(0,229,255,0.35); transform:translateY(-1px); }
    .btn-main:disabled { opacity:0.45; transform:none; box-shadow:none; cursor:not-allowed; }
    .amsg { padding:0.72rem 1rem; border-radius:8px; font-family:'Space Mono',monospace; font-size:clamp(0.7rem,1.7vw,0.78rem); margin-top:0.9rem; display:none; line-height:1.55; }
    .amsg.err { background:rgba(239,68,68,0.09); border:1px solid rgba(239,68,68,0.28); color:#fca5a5; }
    .amsg.ok  { background:rgba(16,185,129,0.09); border:1px solid rgba(16,185,129,0.28); color:#6ee7b7; }

    /* NAV */
    nav { position:sticky; top:0; z-index:100; display:flex; align-items:center; justify-content:space-between; padding:1rem clamp(1.2rem,6vw,3.5rem); background:rgba(6,9,13,0.88); backdrop-filter:blur(20px); border-bottom:1px solid var(--border); }
    .nav-logo { font-family:'Space Mono',monospace; color:var(--accent); font-size:clamp(0.72rem,1.8vw,0.88rem); }
    .nav-r { display:flex; align-items:center; gap:clamp(0.7rem,2vw,1.4rem); }
    .nav-who { font-family:'Space Mono',monospace; font-size:clamp(0.62rem,1.4vw,0.73rem); color:var(--muted); }
    .nav-who span { color:var(--accent); }
    .nav-back { text-decoration:none; font-family:'Space Mono',monospace; font-size:clamp(0.6rem,1.3vw,0.7rem); color:var(--muted); transition:color 0.2s; }
    .nav-back:hover { color:var(--accent); }
    .btn-out { padding:0.42rem clamp(0.6rem,2vw,0.9rem); background:transparent; border:1px solid var(--border); border-radius:6px; color:var(--muted); font-family:'Space Mono',monospace; font-size:clamp(0.58rem,1.4vw,0.68rem); cursor:none; transition:all 0.2s; }
    .btn-out:hover { border-color:var(--red); color:var(--red); }
    .hbg { display:none; flex-direction:column; gap:5px; background:none; border:none; cursor:none; padding:4px; }
    .hbg span { width:21px; height:2px; background:var(--text); border-radius:2px; display:block; transition:all 0.3s; }
    .mob-nav { display:none; position:absolute; top:100%; left:0; right:0; background:rgba(6,9,13,0.97); backdrop-filter:blur(20px); border-bottom:1px solid var(--border); flex-direction:column; padding:1.2rem clamp(1.2rem,6vw,3.5rem); gap:1rem; }
    .mob-nav.open { display:flex; }
    .mob-nav a { text-decoration:none; color:var(--muted); font-family:'Space Mono',monospace; font-size:0.78rem; letter-spacing:0.08em; text-transform:uppercase; transition:color 0.2s; }
    .mob-nav a:hover { color:var(--accent); }

    /* APP */
    #app { display:none; min-height:100vh; position:relative; z-index:1; }
    main { padding:clamp(2rem,6vw,3.5rem) clamp(1.2rem,6vw,3.5rem); max-width:1280px; margin:0 auto; }
    .pg-title { font-size:clamp(1.6rem,5vw,2.6rem); font-weight:800; letter-spacing:-0.02em; margin-bottom:0.5rem; }
    .pg-sub { color:var(--muted); font-size:clamp(0.78rem,1.8vw,0.92rem); margin-bottom:2.5rem; }
    .pg-sub span { color:var(--accent); }

    /* ADD */
    .add-box { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:clamp(1.2rem,4vw,2rem); margin-bottom:2.5rem; }
    .add-eyebrow { font-family:'Space Mono',monospace; font-size:clamp(0.58rem,1.4vw,0.68rem); letter-spacing:0.18em; color:var(--accent); margin-bottom:1rem; }
    .add-row { display:flex; gap:1rem; align-items:flex-end; flex-wrap:wrap; }
    .add-row .fg { flex:1; min-width:180px; margin:0; }
    .btn-add { padding:clamp(0.62rem,2vw,0.78rem) clamp(1rem,3vw,1.8rem); background:var(--accent); color:#06090d; border:none; border-radius:8px; font-family:'Space Mono',monospace; font-size:clamp(0.68rem,1.6vw,0.78rem); font-weight:700; cursor:none; transition:all 0.22s; white-space:nowrap; }
    .btn-add:hover { box-shadow:0 0 22px rgba(0,229,255,0.4); transform:translateY(-1px); }
    .btn-add:disabled { opacity:0.45; transform:none; box-shadow:none; }
    .fb { margin-top:0.9rem; font-family:'Space Mono',monospace; font-size:clamp(0.68rem,1.6vw,0.78rem); display:none; }
    .fb.err { color:#fca5a5; } .fb.ld { color:var(--muted); } .fb.ok { color:#6ee7b7; }

    /* STATS */
    .stats { display:flex; gap:1rem; margin-bottom:2rem; flex-wrap:wrap; }
    .sp { background:var(--card); border:1px solid var(--border); border-radius:10px; padding:0.72rem clamp(0.8rem,3vw,1.5rem); font-family:'Space Mono',monospace; font-size:clamp(0.62rem,1.4vw,0.73rem); color:var(--muted); }
    .sp strong { color:var(--accent); font-size:clamp(0.9rem,2vw,1.1rem); display:block; }

    /* SEARCH */
    .search { width:100%; padding:clamp(0.62rem,2vw,0.78rem) 1rem; background:var(--card); border:1px solid var(--border); border-radius:10px; color:var(--text); font-family:'Syne',sans-serif; font-size:clamp(0.85rem,2vw,0.94rem); outline:none; transition:border-color 0.2s; margin-bottom:2rem; cursor:none; }
    .search:focus { border-color:var(--accent); }
    .search::placeholder { color:var(--muted); }

    /* GRID */
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(clamp(130px,18vw,170px),1fr)); gap:clamp(0.9rem,2vw,1.4rem); }
    .bk { background:var(--card); border:1px solid var(--border); border-radius:14px; overflow:hidden; transition:all 0.28s; position:relative; }
    .bk:hover { transform:translateY(-6px); box-shadow:var(--glow); border-color:rgba(0,229,255,0.28); }
    .bk-img { width:100%; aspect-ratio:2/3; object-fit:cover; display:block; background:var(--surface); }
    .bk-ph { width:100%; aspect-ratio:2/3; background:linear-gradient(135deg,var(--surface),var(--border)); display:flex; align-items:center; justify-content:center; font-size:clamp(1.8rem,4vw,2.4rem); }
    .bk-info { padding:clamp(0.62rem,2vw,0.88rem); }
    .bk-title { font-size:clamp(0.72rem,1.7vw,0.83rem); font-weight:700; line-height:1.3; margin-bottom:0.28rem; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .bk-author { font-size:clamp(0.62rem,1.4vw,0.72rem); color:var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .bk-isbn { font-family:'Space Mono',monospace; font-size:clamp(0.52rem,1.2vw,0.62rem); color:var(--border); margin-top:0.35rem; }
    .bk-del { position:absolute; top:0.5rem; right:0.5rem; width:27px; height:27px; background:rgba(239,68,68,0.14); border:1px solid rgba(239,68,68,0.28); border-radius:50%; color:#fca5a5; font-size:0.72rem; cursor:none; display:flex; align-items:center; justify-content:center; opacity:0; transition:opacity 0.2s; }
    .bk:hover .bk-del { opacity:1; }
    .bk-del:hover { background:rgba(239,68,68,0.32); }

    /* EMPTY */
    .empty { text-align:center; padding:clamp(2.5rem,8vw,5rem) 2rem; color:var(--muted); border:2px dashed var(--border); border-radius:16px; }
    .empty .ico { font-size:clamp(2rem,6vw,3.2rem); margin-bottom:1rem; }
    .empty p { font-size:clamp(0.82rem,1.8vw,0.94rem); line-height:1.7; }

    /* TOAST */
    .toast { position:fixed; bottom:clamp(1rem,3vw,2rem); right:clamp(1rem,3vw,2rem); z-index:999; background:var(--card); border:1px solid var(--border); border-radius:10px; padding:0.9rem 1.4rem; font-family:'Space Mono',monospace; font-size:clamp(0.68rem,1.5vw,0.78rem); transform:translateY(80px); opacity:0; transition:all 0.28s; max-width:min(300px,88vw); pointer-events:none; }
    .toast.show { transform:translateY(0); opacity:1; }
    .toast.ok { border-color:rgba(16,185,129,0.38); color:#6ee7b7; }
    .toast.err { border-color:rgba(239,68,68,0.38); color:#fca5a5; }

    /* FOOTER */
    footer { position:relative; z-index:1; border-top:1px solid var(--border); padding:1.6rem clamp(1.2rem,6vw,3.5rem); display:flex; justify-content:space-between; align-items:center; font-family:'Space Mono',monospace; font-size:clamp(0.58rem,1.4vw,0.68rem); color:var(--muted); flex-wrap:wrap; gap:0.5rem; }

    /* ANIMATIONS */
    @keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .reveal{opacity:0;transform:translateY(24px);transition:opacity 0.6s ease,transform 0.6s ease;}
    .reveal.on{opacity:1;transform:translateY(0);}

    /* RESPONSIVE */
    @media(max-width:768px){
      .hbg{display:flex;}
      .nav-who{display:none;}
      .nav-back{display:none;}
    }
    @media(max-width:480px){
      .add-row{flex-direction:column;}
      .btn-add{width:100%;text-align:center;}
      .stats{flex-direction:column;}
      footer{flex-direction:column;text-align:center;}
    }
    @media(min-width:1400px){
      .grid{grid-template-columns:repeat(auto-fill,minmax(190px,1fr));}
    }
  </style>
</head>
<body>

<div class="cursor" id="cur"></div>
<div class="cursor-ring" id="curR"></div>

<!-- LOADER -->
<div id="loader">
  <div class="ld-logo">üìö BOOK LIBRARY</div>
  <div class="spinner"></div>
</div>

<!-- AUTH -->
<div id="authWrap">
  <div class="auth-card">
    <div class="auth-logo">üìö BOOK LIBRARY</div>
    <h1 class="auth-h" id="authH">Welcome Back</h1>
    <p class="auth-sub" id="authS">Sign in to your personal cloud-synced book collection.</p>
    <div class="tabs">
      <button class="tab on" onclick="switchTab('in')">SIGN IN</button>
      <button class="tab" onclick="switchTab('up')">SIGN UP</button>
    </div>

    <!-- LOGIN -->
    <div id="fIn">
      <div class="fg"><label>EMAIL</label><input type="email" id="lEmail" placeholder="your@email.com" autocomplete="email"/></div>
      <div class="fg"><label>PASSWORD</label><input type="password" id="lPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/></div>
      <button class="btn-main" id="lBtn" onclick="login()">SIGN IN ‚Üí</button>
      <div class="amsg err" id="lErr"></div>
    </div>

    <!-- SIGNUP -->
    <div id="fUp" style="display:none">
      <div class="fg">
        <label>USERNAME <span style="font-size:0.6rem;color:var(--muted)">(letters, numbers, underscores ¬∑ min 3 chars)</span></label>
        <input type="text" id="uName" placeholder="e.g. sohailsameer" autocomplete="username"/>
      </div>
      <div class="fg"><label>EMAIL</label><input type="email" id="uEmail" placeholder="your@email.com" autocomplete="email"/></div>
      <div class="fg">
        <label>PASSWORD <span style="font-size:0.6rem;color:var(--muted)">(min 6 characters)</span></label>
        <input type="password" id="uPass" placeholder="choose a password" autocomplete="new-password"/>
      </div>
      <div class="fg"><label>CONFIRM PASSWORD</label><input type="password" id="uPass2" placeholder="repeat password" autocomplete="new-password"/></div>
      <button class="btn-main" id="uBtn" onclick="signup()">CREATE ACCOUNT ‚Üí</button>
      <div class="amsg err" id="uErr"></div>
      <div class="amsg ok"  id="uOk"></div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <nav>
    <div class="nav-logo">üìö BOOK LIBRARY</div>
    <div class="nav-r">
      <div class="nav-who">Logged in as <span id="navWho"></span></div>
      <a href="index.html" class="nav-back">‚Üê PORTFOLIO</a>
      <button class="btn-out" onclick="logout()">SIGN OUT</button>
      <button class="hbg" id="hbg"><span></span><span></span><span></span></button>
    </div>
    <div class="mob-nav" id="mobNav">
      <a href="index.html">‚Üê Back to Portfolio</a>
      <a href="#" onclick="logout()">Sign Out</a>
    </div>
  </nav>

  <main>
    <div class="reveal">
      <h1 class="pg-title" id="pgTitle">My Library</h1>
      <p class="pg-sub">Your personal collection ¬∑ <span id="bkCnt">0</span> books ¬∑ ‚òÅÔ∏è synced across all devices</p>
    </div>

    <div class="add-box reveal">
      <div class="add-eyebrow">+ ADD A BOOK BY ISBN</div>
      <div class="add-row">
        <div class="fg">
          <label>ISBN NUMBER</label>
          <input type="text" id="isbn" placeholder="e.g. 9780140449136" maxlength="20" onkeydown="if(event.key==='Enter')addBook()"/>
        </div>
        <button class="btn-add" id="addBtn" onclick="addBook()">FETCH &amp; ADD</button>
      </div>
      <div class="fb" id="fb"></div>
    </div>

    <div class="stats reveal" id="stats" style="display:none">
      <div class="sp"><strong id="stTotal">0</strong>Total Books</div>
      <div class="sp"><strong id="stLast">‚Äî</strong>Last Added</div>
      <div class="sp" style="border-color:rgba(16,185,129,0.22)"><strong style="color:#6ee7b7">‚òÅÔ∏è</strong>Cloud Synced</div>
    </div>

    <input class="search reveal" type="text" id="srch" placeholder="üîç  Search by title or author..." oninput="filterBooks()" style="display:none"/>

    <div id="grid" class="grid"></div>
    <div id="empty" class="empty reveal" style="display:none">
      <div class="ico">üìñ</div>
      <p>Your library is empty.<br/>Add your first book using the ISBN field above!</p>
    </div>
  </main>

  <footer>
    <span>üìö Book Library ‚Äî <span id="footWho"></span></span>
    <span>Powered by Supabase &amp; Open Library</span>
  </footer>
</div>

<div class="toast" id="toast"></div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SB_URL  = 'https://zqtqvnvylwzshwqwnkhz.supabase.co';
  const SB_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxdHF2bnZ5bHd6c2h3cXdua2h6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NjAyNjgsImV4cCI6MjA4NzQzNjI2OH0.Ix3MH12xSgBnNtE_Vaa25gP2LGyO0KYctNmLfQIq8cc';

  const { createClient } = supabase;
  const sb = createClient(SB_URL, SB_ANON);
  const $  = id => document.getElementById(id);
  let books = [], me = null;

  /* ‚îÄ‚îÄ CURSOR ‚îÄ‚îÄ */
  const cur=$('cur'), curR=$('curR');
  let mx=0,my=0,rx=0,ry=0;
  document.addEventListener('mousemove',e=>{mx=e.clientX;my=e.clientY;cur.style.left=mx-5+'px';cur.style.top=my-5+'px';});
  (function tick(){rx+=(mx-rx-17)*0.12;ry+=(my-ry-17)*0.12;curR.style.left=rx+'px';curR.style.top=ry+'px';requestAnimationFrame(tick);})();
  function curHover(el){
    el.addEventListener('mouseenter',()=>{cur.style.transform='scale(2.2)';curR.style.width='56px';curR.style.height='56px';curR.style.borderColor='var(--accent2)';});
    el.addEventListener('mouseleave',()=>{cur.style.transform='scale(1)';curR.style.width='34px';curR.style.height='34px';curR.style.borderColor='var(--accent)';});
  }
  document.querySelectorAll('a,button,input').forEach(curHover);

  /* ‚îÄ‚îÄ HAMBURGER ‚îÄ‚îÄ */
  $('hbg').addEventListener('click',()=>$('mobNav').classList.toggle('open'));

  /* ‚îÄ‚îÄ REVEAL ‚îÄ‚îÄ */
  const rObs=new IntersectionObserver(es=>{
    es.forEach((e,i)=>{if(!e.isIntersecting)return;setTimeout(()=>e.target.classList.add('on'),i*70);rObs.unobserve(e.target);});
  },{threshold:0.1});
  document.querySelectorAll('.reveal').forEach(r=>rObs.observe(r));

  /* ‚îÄ‚îÄ STARTUP ‚îÄ‚îÄ */
  window.addEventListener('load',async()=>{
    const {data:{session}}=await sb.auth.getSession();
    $('loader').style.display='none';
    if(session){me=session.user;loadApp(session.user);}
    else $('authWrap').style.display='flex';

    sb.auth.onAuthStateChange((_,s)=>{
      if(s){me=s.user;loadApp(s.user);}
      else{me=null;books=[];$('app').style.display='none';$('authWrap').style.display='flex';}
    });
  });

  /* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
  window.switchTab=tab=>{
    $('fIn').style.display=tab==='in'?'block':'none';
    $('fUp').style.display=tab==='up'?'block':'none';
    $('authH').textContent=tab==='in'?'Welcome Back':'Create Account';
    $('authS').textContent=tab==='in'
      ?'Sign in to your personal cloud-synced book collection.'
      :'Create your free account ‚Äî no credit card needed.';
    document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('on',(tab==='in'&&i===0)||(tab==='up'&&i===1)));
  };

  /* ‚îÄ‚îÄ ERROR HELPER ‚îÄ‚îÄ */
  function sbErr(msg){
    const m={'Invalid login credentials':'Incorrect email or password.','Email not confirmed':'Confirm your email first, then sign in.','User already registered':'An account with this email already exists.','Password should be at least 6':'Password must be at least 6 characters.','For security purposes':'Too many attempts. Please wait a moment.'};
    for(const[k,v]of Object.entries(m))if(msg.includes(k))return v;
    return msg||'Something went wrong. Please try again.';
  }
  function showMsg(id,msg,type='err'){
    const el=$(id);el.textContent=msg;el.className='amsg '+type;el.style.display='block';
    if(type!=='ok')setTimeout(()=>el.style.display='none',5000);
  }

  /* ‚îÄ‚îÄ SIGN UP ‚îÄ‚îÄ */
  window.signup=async()=>{
    const un=$('uName').value.trim(),em=$('uEmail').value.trim(),pw=$('uPass').value,pw2=$('uPass2').value;
    if(!un||!em||!pw||!pw2)return showMsg('uErr','Please fill in all fields.');
    if(un.length<3)return showMsg('uErr','Username must be at least 3 characters.');
    if(!/^[a-zA-Z0-9_]+$/.test(un))return showMsg('uErr','Username: letters, numbers, underscores only.');
    if(pw!==pw2)return showMsg('uErr','Passwords do not match.');
    $('uBtn').disabled=true;$('uBtn').textContent='CREATING...';
    const{error}=await sb.auth.signUp({email:em,password:pw,options:{data:{username:un}}});
    $('uBtn').disabled=false;$('uBtn').textContent='CREATE ACCOUNT ‚Üí';
    if(error)return showMsg('uErr',sbErr(error.message));
    $('uErr').style.display='none';
    showMsg('uOk','‚úì Account created! Check your email ('+em+') and click the confirmation link, then sign in.','ok');
  };

  /* ‚îÄ‚îÄ SIGN IN ‚îÄ‚îÄ */
  window.login=async()=>{
    const em=$('lEmail').value.trim(),pw=$('lPass').value;
    if(!em||!pw)return showMsg('lErr','Please fill in all fields.');
    $('lBtn').disabled=true;$('lBtn').textContent='SIGNING IN...';
    const{error}=await sb.auth.signInWithPassword({email:em,password:pw});
    if(error){showMsg('lErr',sbErr(error.message));$('lBtn').disabled=false;$('lBtn').textContent='SIGN IN ‚Üí';}
  };

  /* ‚îÄ‚îÄ LOGOUT ‚îÄ‚îÄ */
  window.logout=async()=>{await sb.auth.signOut();books=[];$('grid').innerHTML='';};

  /* ‚îÄ‚îÄ LOAD APP ‚îÄ‚îÄ */
  async function loadApp(user){
    const un=user.user_metadata?.username||user.email.split('@')[0];
    $('authWrap').style.display='none';$('app').style.display='block';
    $('navWho').textContent=un;$('pgTitle').textContent=un+"'s Library";$('footWho').textContent=un;
    await fetchBooks(user.id);
  }

  /* ‚îÄ‚îÄ FETCH ‚îÄ‚îÄ */
  async function fetchBooks(uid){
    const{data,error}=await sb.from('books').select('*').eq('user_id',uid).order('added_at',{ascending:false});
    if(error){toast('Error loading books.','err');return;}
    books=data||[];render();
  }

  /* ‚îÄ‚îÄ ADD ‚îÄ‚îÄ */
  window.addBook=async()=>{
    const isbn=$('isbn').value.trim().replace(/[-\s]/g,'');
    if(!isbn)return fb('Please enter an ISBN number.','err');
    if(!/^\d{10}(\d{3})?$/.test(isbn))return fb('Enter a valid 10 or 13-digit ISBN.','err');
    if(books.find(b=>b.isbn===isbn))return fb('This book is already in your library!','err');
    fb('Looking up book...','ld');$('addBtn').disabled=true;
    try{
      const res=await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${isbn}&format=json&jscmd=data`);
      const data=await res.json();const key=`ISBN:${isbn}`;
      if(!data[key]){fb('Book not found. Check the ISBN and try again.','err');$('addBtn').disabled=false;return;}
      const info=data[key];
      const bk={user_id:me.id,isbn,title:info.title||'Unknown Title',authors:info.authors?.map(a=>a.name).join(', ')||'Unknown Author',cover:info.cover?.medium||info.cover?.small||null,added_at:new Date().toISOString()};
      const{data:ins,error}=await sb.from('books').insert([bk]).select().single();
      if(error){fb('Error saving: '+error.message,'err');$('addBtn').disabled=false;return;}
      books.unshift(ins);$('isbn').value='';
      fb(`"${bk.title}" added!`,'ok');render();toast(`üìö "${bk.title}" added!`,'ok');
    }catch(e){fb('Network error. Check your connection.','err');}
    $('addBtn').disabled=false;
  };

  /* ‚îÄ‚îÄ DELETE ‚îÄ‚îÄ */
  window.delBook=async(id,title,e)=>{
    e.stopPropagation();
    const{error}=await sb.from('books').delete().eq('id',id).eq('user_id',me.id);
    if(error){toast('Error removing book.','err');return;}
    books=books.filter(b=>b.id!==id);render();
    toast(`üóëÔ∏è "${title}" removed.`,'err');
  };

  /* ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ */
  function render(list=null){
    const bks=list??books;
    const g=$('grid'),em=$('empty'),st=$('stats'),sr=$('srch');
    $('bkCnt').textContent=books.length;
    $('stTotal').textContent=books.length;
    $('stLast').textContent=books[0]?new Date(books[0].added_at).toLocaleDateString('en-IN',{day:'numeric',month:'short'}):'‚Äî';
    if(books.length===0){
      g.style.display='none';em.style.display='block';st.style.display='none';sr.style.display='none';
      rObs.observe(em);return;
    }
    em.style.display='none';g.style.display='grid';st.style.display='flex';sr.style.display='block';
    if(bks.length===0){
      g.innerHTML=`<p style="color:var(--muted);font-family:'Space Mono',monospace;font-size:0.78rem;grid-column:1/-1">No books match your search.</p>`;return;
    }
    g.innerHTML='';
    bks.forEach(b=>{
      const st=b.title.replace(/'/g,"\\'").replace(/"/g,'&quot;');
      const c=document.createElement('div');c.className='bk';
      c.innerHTML=`
        <button class="bk-del" onclick="delBook(${b.id},'${st}',event)" title="Remove">‚úï</button>
        ${b.cover
          ?`<img class="bk-img" src="${b.cover}" alt="${b.title}" loading="lazy" onerror="this.outerHTML='<div class=\\'bk-ph\\'>üìò</div>'">`
          :`<div class="bk-ph">üìò</div>`}
        <div class="bk-info">
          <div class="bk-title">${b.title}</div>
          <div class="bk-author">${b.authors}</div>
          <div class="bk-isbn">${b.isbn}</div>
        </div>`;
      g.appendChild(c);
      curHover(c);
    });
  }

  /* ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ */
  window.filterBooks=()=>{
    const q=$('srch').value.toLowerCase();
    render(books.filter(b=>b.title.toLowerCase().includes(q)||b.authors.toLowerCase().includes(q)));
  };

  /* ‚îÄ‚îÄ FEEDBACK ‚îÄ‚îÄ */
  function fb(msg,type){
    const el=$('fb');
    el.textContent=type==='ld'?'‚è≥ '+msg:type==='err'?'‚úó '+msg:'‚úì '+msg;
    el.className='fb '+type;el.style.display='block';
    if(type!=='ld')setTimeout(()=>el.style.display='none',4000);
  }

  /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
  function toast(msg,type='ok'){
    const t=$('toast');t.textContent=msg;t.className='toast '+type+' show';
    setTimeout(()=>t.className='toast '+type,3200);
  }

  /* ‚îÄ‚îÄ ENTER KEYS ‚îÄ‚îÄ */
  document.addEventListener('keydown',e=>{
    if(e.key!=='Enter')return;
    if($('fIn').style.display!=='none')window.login();
    else if($('fUp').style.display!=='none')window.signup();
  });
</script>
</body>
</html>
