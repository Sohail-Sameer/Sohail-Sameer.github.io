<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Book Library</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
    :root {
      --bg:#080c10; --surface:#0e1318; --card:#12181f; --border:#1e2a35;
      --accent:#00e5ff; --accent2:#7c3aed; --red:#ef4444;
      --text:#e2e8f0; --muted:#64748b; --glow:0 0 30px rgba(0,229,255,0.15);
    }
    html { scroll-behavior:smooth; }
    body { background:var(--bg); color:var(--text); font-family:'Syne',sans-serif; min-height:100vh; overflow-x:hidden; cursor:none; }
    body::after { content:''; position:fixed; inset:0; background-image:linear-gradient(rgba(0,229,255,0.02) 1px,transparent 1px),linear-gradient(90deg,rgba(0,229,255,0.02) 1px,transparent 1px); background-size:60px 60px; pointer-events:none; z-index:0; }

    /* CURSOR */
    .cursor { position:fixed; width:12px; height:12px; background:var(--accent); border-radius:50%; pointer-events:none; z-index:9999; transition:transform 0.1s ease; mix-blend-mode:screen; }
    .cursor-ring { position:fixed; width:36px; height:36px; border:1.5px solid var(--accent); border-radius:50%; pointer-events:none; z-index:9998; opacity:0.5; transition:width 0.2s,height 0.2s,border-color 0.2s; }

    /* LOADER */
    #globalLoader { position:fixed; inset:0; z-index:200; background:var(--bg); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:1.2rem; }
    .loader-logo { font-family:'Space Mono',monospace; color:var(--accent); font-size:clamp(0.9rem,2vw,1.1rem); letter-spacing:0.1em; }
    .spinner { width:36px; height:36px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 0.8s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* AUTH */
    #authScreen { position:fixed; inset:0; z-index:100; display:none; align-items:center; justify-content:center; background:var(--bg); padding:1rem; }
    .auth-box {
      background:var(--card); border:1px solid var(--border); border-radius:20px;
      padding:clamp(1.5rem,5vw,2.5rem); width:100%; max-width:440px;
      box-shadow:0 0 60px rgba(0,229,255,0.07);
    }
    .auth-logo { font-family:'Space Mono',monospace; color:var(--accent); font-size:0.85rem; margin-bottom:1.5rem; letter-spacing:0.1em; }
    .auth-title { font-size:clamp(1.4rem,4vw,1.8rem); font-weight:800; margin-bottom:0.4rem; }
    .auth-sub { color:var(--muted); font-size:clamp(0.8rem,2vw,0.88rem); margin-bottom:2rem; line-height:1.5; }
    .auth-tabs { display:flex; margin-bottom:2rem; border:1px solid var(--border); border-radius:8px; overflow:hidden; }
    .auth-tab { flex:1; padding:0.65rem; text-align:center; font-family:'Space Mono',monospace; font-size:clamp(0.65rem,2vw,0.75rem); letter-spacing:0.05em; cursor:none; transition:all 0.2s; color:var(--muted); background:transparent; border:none; }
    .auth-tab.active { background:var(--accent); color:#080c10; font-weight:700; }
    .form-group { margin-bottom:1.1rem; }
    .form-group label { display:block; font-family:'Space Mono',monospace; font-size:clamp(0.6rem,1.5vw,0.68rem); letter-spacing:0.1em; color:var(--muted); margin-bottom:0.45rem; }
    .form-group input { width:100%; padding:clamp(0.65rem,2vw,0.8rem) 1rem; background:var(--surface); border:1px solid var(--border); border-radius:8px; color:var(--text); font-family:'Syne',sans-serif; font-size:clamp(0.85rem,2vw,0.95rem); transition:border-color 0.2s; outline:none; cursor:none; }
    .form-group input:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(0,229,255,0.07); }
    .btn-full { width:100%; padding:0.9rem; background:var(--accent); color:#080c10; border:none; border-radius:8px; font-family:'Space Mono',monospace; font-size:clamp(0.75rem,2vw,0.85rem); font-weight:700; letter-spacing:0.05em; cursor:none; transition:all 0.25s; margin-top:0.5rem; }
    .btn-full:hover { box-shadow:0 0 30px rgba(0,229,255,0.35); transform:translateY(-1px); }
    .btn-full:disabled { opacity:0.5; cursor:not-allowed; transform:none; box-shadow:none; }
    .auth-msg { padding:0.75rem 1rem; border-radius:8px; font-size:clamp(0.75rem,2vw,0.82rem); margin-top:1rem; display:none; font-family:'Space Mono',monospace; line-height:1.5; }
    .auth-msg.error { background:rgba(239,68,68,0.1); border:1px solid rgba(239,68,68,0.3); color:#fca5a5; }
    .auth-msg.success { background:rgba(16,185,129,0.1); border:1px solid rgba(16,185,129,0.3); color:#6ee7b7; }

    /* NAV */
    nav { position:sticky; top:0; z-index:50; display:flex; align-items:center; justify-content:space-between; padding:1rem 6vw; background:rgba(8,12,16,0.9); backdrop-filter:blur(16px); border-bottom:1px solid var(--border); }
    .nav-logo { font-family:'Space Mono',monospace; color:var(--accent); font-size:clamp(0.75rem,2vw,0.9rem); }
    .nav-right { display:flex; align-items:center; gap:clamp(0.75rem,2vw,1.5rem); }
    .nav-user { font-family:'Space Mono',monospace; font-size:clamp(0.65rem,1.5vw,0.75rem); color:var(--muted); }
    .nav-user span { color:var(--accent); }
    .btn-logout { padding:0.45rem clamp(0.6rem,2vw,1rem); background:transparent; border:1px solid var(--border); border-radius:6px; color:var(--muted); font-family:'Space Mono',monospace; font-size:clamp(0.6rem,1.5vw,0.7rem); cursor:none; transition:all 0.2s; }
    .btn-logout:hover { border-color:var(--red); color:var(--red); }
    .hamburger { display:none; flex-direction:column; gap:5px; cursor:none; border:none; background:none; padding:0.2rem; }
    .hamburger span { width:22px; height:2px; background:var(--text); border-radius:2px; display:block; transition:all 0.3s; }

    /* APP */
    #appScreen { display:none; min-height:100vh; position:relative; z-index:1; }
    main { padding:clamp(1.5rem,5vw,3rem) 6vw; max-width:1200px; margin:0 auto; }
    .page-title { font-size:clamp(1.5rem,5vw,2.5rem); font-weight:800; letter-spacing:-0.02em; margin-bottom:0.5rem; }
    .page-sub { color:var(--muted); font-size:clamp(0.8rem,2vw,0.95rem); margin-bottom:2.5rem; }
    .page-sub span { color:var(--accent); }

    /* ADD BOOK */
    .add-section { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:clamp(1.2rem,4vw,2rem); margin-bottom:2.5rem; }
    .add-label { font-family:'Space Mono',monospace; font-size:clamp(0.6rem,1.5vw,0.7rem); letter-spacing:0.15em; color:var(--accent); margin-bottom:1rem; }
    .add-row { display:flex; gap:1rem; align-items:flex-end; flex-wrap:wrap; }
    .add-row .form-group { flex:1; min-width:180px; margin:0; }
    .btn-add { padding:clamp(0.65rem,2vw,0.8rem) clamp(1rem,3vw,2rem); background:var(--accent); color:#080c10; border:none; border-radius:8px; font-family:'Space Mono',monospace; font-size:clamp(0.7rem,2vw,0.8rem); font-weight:700; cursor:none; transition:all 0.25s; white-space:nowrap; }
    .btn-add:hover { box-shadow:0 0 20px rgba(0,229,255,0.4); transform:translateY(-1px); }
    .btn-add:disabled { opacity:0.5; cursor:not-allowed; transform:none; box-shadow:none; }
    .add-feedback { margin-top:1rem; font-family:'Space Mono',monospace; font-size:clamp(0.7rem,2vw,0.8rem); display:none; }
    .add-feedback.error { color:#fca5a5; }
    .add-feedback.loading { color:var(--muted); }
    .add-feedback.success { color:#6ee7b7; }

    /* STATS */
    .stats-row { display:flex; gap:1rem; margin-bottom:2rem; flex-wrap:wrap; }
    .stat-pill { background:var(--card); border:1px solid var(--border); border-radius:10px; padding:0.75rem clamp(0.75rem,3vw,1.5rem); font-family:'Space Mono',monospace; font-size:clamp(0.65rem,1.5vw,0.75rem); color:var(--muted); }
    .stat-pill strong { color:var(--accent); font-size:clamp(0.9rem,2vw,1.1rem); display:block; }

    /* SEARCH */
    .search-bar { width:100%; padding:clamp(0.65rem,2vw,0.8rem) 1rem; background:var(--card); border:1px solid var(--border); border-radius:10px; color:var(--text); font-family:'Syne',sans-serif; font-size:clamp(0.85rem,2vw,0.95rem); outline:none; transition:border-color 0.2s; margin-bottom:2rem; cursor:none; }
    .search-bar:focus { border-color:var(--accent); }
    .search-bar::placeholder { color:var(--muted); }

    /* BOOKS GRID */
    .books-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(clamp(130px,20vw,170px),1fr)); gap:clamp(1rem,2vw,1.5rem); }
    .book-card { background:var(--card); border:1px solid var(--border); border-radius:14px; overflow:hidden; transition:all 0.3s; position:relative; }
    .book-card:hover { transform:translateY(-6px); box-shadow:var(--glow); border-color:rgba(0,229,255,0.3); }
    .book-cover { width:100%; aspect-ratio:2/3; object-fit:cover; display:block; background:var(--surface); }
    .book-cover-placeholder { width:100%; aspect-ratio:2/3; background:linear-gradient(135deg,var(--surface),var(--border)); display:flex; align-items:center; justify-content:center; font-size:clamp(1.8rem,4vw,2.5rem); }
    .book-info { padding:clamp(0.65rem,2vw,0.9rem); }
    .book-title { font-size:clamp(0.75rem,1.8vw,0.85rem); font-weight:700; line-height:1.3; margin-bottom:0.3rem; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .book-author { font-size:clamp(0.65rem,1.5vw,0.75rem); color:var(--muted); display:-webkit-box; -webkit-line-clamp:1; -webkit-box-orient:vertical; overflow:hidden; }
    .book-isbn { font-family:'Space Mono',monospace; font-size:clamp(0.55rem,1.2vw,0.65rem); color:var(--border); margin-top:0.4rem; }
    .book-delete { position:absolute; top:0.5rem; right:0.5rem; width:28px; height:28px; background:rgba(239,68,68,0.15); border:1px solid rgba(239,68,68,0.3); border-radius:50%; color:#fca5a5; font-size:0.75rem; cursor:none; display:flex; align-items:center; justify-content:center; opacity:0; transition:opacity 0.2s; }
    .book-card:hover .book-delete { opacity:1; }
    .book-delete:hover { background:rgba(239,68,68,0.35); }

    /* EMPTY */
    .empty-state { text-align:center; padding:clamp(2rem,8vw,4rem) 2rem; color:var(--muted); border:2px dashed var(--border); border-radius:16px; }
    .empty-state .icon { font-size:clamp(2rem,6vw,3rem); margin-bottom:1rem; }
    .empty-state p { font-size:clamp(0.85rem,2vw,0.95rem); line-height:1.7; }

    /* TOAST */
    .toast { position:fixed; bottom:clamp(1rem,3vw,2rem); right:clamp(1rem,3vw,2rem); z-index:999; background:var(--card); border:1px solid var(--border); border-radius:10px; padding:1rem 1.5rem; font-family:'Space Mono',monospace; font-size:clamp(0.7rem,1.5vw,0.8rem); transform:translateY(80px); opacity:0; transition:all 0.3s; max-width:min(320px,90vw); pointer-events:none; }
    .toast.show { transform:translateY(0); opacity:1; }
    .toast.success { border-color:rgba(16,185,129,0.4); color:#6ee7b7; }
    .toast.error { border-color:rgba(239,68,68,0.4); color:#fca5a5; }

    /* FOOTER */
    footer { border-top:1px solid var(--border); padding:1.5rem 6vw; display:flex; justify-content:space-between; align-items:center; font-family:'Space Mono',monospace; font-size:clamp(0.6rem,1.5vw,0.7rem); color:var(--muted); position:relative; z-index:1; flex-wrap:wrap; gap:0.5rem; }

    /* ANIMATIONS */
    @keyframes fadeUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
    .reveal { opacity:0; transform:translateY(24px); transition:opacity 0.6s ease,transform 0.6s ease; }
    .reveal.visible { opacity:1; transform:translateY(0); }

    /* RESPONSIVE BREAKPOINTS */
    @media (max-width:768px) {
      .hamburger { display:flex; }
      .nav-user { display:none; }
      .nav-links-mobile { display:none; position:absolute; top:100%; left:0; right:0; background:rgba(8,12,16,0.98); backdrop-filter:blur(16px); flex-direction:column; padding:1.5rem 6vw; border-bottom:1px solid var(--border); gap:1rem; }
      .nav-links-mobile.open { display:flex; }
      .nav-links-mobile a { color:var(--muted); text-decoration:none; font-family:'Space Mono',monospace; font-size:0.8rem; letter-spacing:0.08em; text-transform:uppercase; }
      .nav-links-mobile a:hover { color:var(--accent); }
      .add-row { flex-direction:column; }
      .btn-add { width:100%; text-align:center; }
    }

    @media (max-width:480px) {
      .stats-row { flex-direction:column; }
      .stat-pill { display:flex; align-items:center; gap:1rem; }
      .stat-pill strong { display:inline; font-size:1rem; }
      footer { flex-direction:column; text-align:center; }
    }

    @media (min-width:1400px) {
      .books-grid { grid-template-columns:repeat(auto-fill,minmax(190px,1fr)); }
    }
  </style>
</head>
<body>

<div class="cursor" id="cursor"></div>
<div class="cursor-ring" id="cursorRing"></div>

<!-- LOADER -->
<div id="globalLoader">
  <div class="loader-logo">üìö BOOK LIBRARY</div>
  <div class="spinner"></div>
</div>

<!-- AUTH -->
<div id="authScreen">
  <div class="auth-box">
    <div class="auth-logo">üìö BOOK LIBRARY</div>
    <h1 class="auth-title" id="authTitle">Welcome Back</h1>
    <p class="auth-sub" id="authSub">Sign in to your personal cloud-synced book collection.</p>
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchTab('login')">SIGN IN</button>
      <button class="auth-tab" onclick="switchTab('signup')">SIGN UP</button>
    </div>

    <div id="loginForm">
      <div class="form-group"><label>EMAIL</label><input type="email" id="loginEmail" placeholder="your@email.com" autocomplete="email"/></div>
      <div class="form-group"><label>PASSWORD</label><input type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/></div>
      <button class="btn-full" id="loginBtn" onclick="login()">SIGN IN ‚Üí</button>
      <div class="auth-msg error" id="loginError"></div>
    </div>

    <div id="signupForm" style="display:none">
      <div class="form-group">
        <label>USERNAME <span style="font-size:0.62rem;color:var(--muted)">(letters, numbers, underscores)</span></label>
        <input type="text" id="signupUsername" placeholder="e.g. sohailsameer" autocomplete="username"/>
      </div>
      <div class="form-group"><label>EMAIL</label><input type="email" id="signupEmail" placeholder="your@email.com" autocomplete="email"/></div>
      <div class="form-group">
        <label>PASSWORD <span style="font-size:0.62rem;color:var(--muted)">(min. 6 characters)</span></label>
        <input type="password" id="signupPass" placeholder="choose a password" autocomplete="new-password"/>
      </div>
      <div class="form-group"><label>CONFIRM PASSWORD</label><input type="password" id="signupPass2" placeholder="repeat your password" autocomplete="new-password"/></div>
      <button class="btn-full" id="signupBtn" onclick="signup()">CREATE ACCOUNT ‚Üí</button>
      <div class="auth-msg error" id="signupError"></div>
      <div class="auth-msg success" id="signupSuccess"></div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="appScreen">
  <nav>
    <div class="nav-logo">üìö BOOK LIBRARY</div>
    <div class="nav-right">
      <div class="nav-user">Logged in as <span id="navUsername"></span></div>
      <a href="index.html" style="color:var(--muted);font-family:'Space Mono',monospace;font-size:0.7rem;text-decoration:none;display:none" class="nav-portfolio-link" id="portfolioLink">‚Üê PORTFOLIO</a>
      <button class="btn-logout" onclick="logout()">SIGN OUT</button>
      <button class="hamburger" id="hamburger"><span></span><span></span><span></span></button>
    </div>
    <div class="nav-links-mobile" id="mobileMenu">
      <a href="index.html">‚Üê Back to Portfolio</a>
      <a href="#" onclick="logout()">Sign Out</a>
    </div>
  </nav>

  <main>
    <div class="reveal">
      <h1 class="page-title" id="pageTitle">My Library</h1>
      <p class="page-sub">Your personal collection ¬∑ <span id="bookCount">0</span> books ¬∑ ‚òÅÔ∏è synced across all your devices</p>
    </div>

    <div class="add-section reveal">
      <div class="add-label">+ ADD A BOOK BY ISBN</div>
      <div class="add-row">
        <div class="form-group">
          <label>ISBN NUMBER</label>
          <input type="text" id="isbnInput" placeholder="e.g. 9780140449136" maxlength="20" onkeydown="if(event.key==='Enter')addBook()"/>
        </div>
        <button class="btn-add" id="addBtn" onclick="addBook()">FETCH &amp; ADD</button>
      </div>
      <div class="add-feedback" id="addFeedback"></div>
    </div>

    <div class="stats-row reveal" id="statsRow" style="display:none">
      <div class="stat-pill"><strong id="statTotal">0</strong>Total Books</div>
      <div class="stat-pill"><strong id="statRecent">‚Äî</strong>Last Added</div>
      <div class="stat-pill" style="border-color:rgba(16,185,129,0.25)"><strong style="color:#6ee7b7">‚òÅÔ∏è</strong>Cloud Synced</div>
    </div>

    <input class="search-bar reveal" type="text" id="searchBar" placeholder="üîç  Search by title or author..." oninput="filterBooks()" style="display:none"/>

    <div id="booksGrid" class="books-grid"></div>
    <div id="emptyState" class="empty-state reveal" style="display:none">
      <div class="icon">üìñ</div>
      <p>Your library is empty.<br/>Add your first book by entering an ISBN above!</p>
    </div>
  </main>

  <footer>
    <span>üìö Book Library ‚Äî <span id="footerUser"></span></span>
    <span>Powered by Supabase ¬∑ Open Library</span>
  </footer>
</div>

<div class="toast" id="toast"></div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL  = 'https://zqtqvnvylwzshwqwnkhz.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxdHF2bnZ5bHd6c2h3cXdua2h6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NjAyNjgsImV4cCI6MjA4NzQzNjI2OH0.Ix3MH12xSgBnNtE_Vaa25gP2LGyO0KYctNmLfQIq8cc';

  const { createClient } = supabase;
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON);
  const $ = id => document.getElementById(id);
  let allBooks = [], currentUser = null;

  // ‚îÄ‚îÄ CURSOR ‚îÄ‚îÄ
  const cursor = $('cursor'), ring = $('cursorRing');
  let mx=0, my=0, rx=0, ry=0;
  document.addEventListener('mousemove', e => {
    mx=e.clientX; my=e.clientY;
    cursor.style.left=mx-6+'px'; cursor.style.top=my-6+'px';
  });
  (function animateRing() {
    rx+=(mx-rx-18)*0.12; ry+=(my-ry-18)*0.12;
    ring.style.left=rx+'px'; ring.style.top=ry+'px';
    requestAnimationFrame(animateRing);
  })();
  document.querySelectorAll('a,button,input,.book-card').forEach(el => {
    el.addEventListener('mouseenter', () => { cursor.style.transform='scale(2)'; ring.style.width='56px'; ring.style.height='56px'; ring.style.borderColor='var(--accent2)'; });
    el.addEventListener('mouseleave', () => { cursor.style.transform='scale(1)'; ring.style.width='36px'; ring.style.height='36px'; ring.style.borderColor='var(--accent)'; });
  });

  // ‚îÄ‚îÄ HAMBURGER ‚îÄ‚îÄ
  $('hamburger').addEventListener('click', () => $('mobileMenu').classList.toggle('open'));

  // ‚îÄ‚îÄ REVEAL ON SCROLL ‚îÄ‚îÄ
  const revealObs = new IntersectionObserver(entries => {
    entries.forEach((e,i) => { if(e.isIntersecting){ setTimeout(()=>e.target.classList.add('visible'),i*80); revealObs.unobserve(e.target); } });
  }, { threshold:0.1 });
  document.querySelectorAll('.reveal').forEach(r => revealObs.observe(r));

  // ‚îÄ‚îÄ STARTUP ‚îÄ‚îÄ
  window.addEventListener('load', async () => {
    const { data:{ session } } = await sb.auth.getSession();
    $('globalLoader').style.display = 'none';
    session ? (currentUser=session.user, loadApp(session.user)) : ($('authScreen').style.display='flex');

    sb.auth.onAuthStateChange((_,session) => {
      if (session) { currentUser=session.user; loadApp(session.user); }
      else { currentUser=null; $('appScreen').style.display='none'; $('authScreen').style.display='flex'; allBooks=[]; }
    });
  });

  // ‚îÄ‚îÄ TAB SWITCH ‚îÄ‚îÄ
  window.switchTab = tab => {
    $('loginForm').style.display  = tab==='login'  ? 'block' : 'none';
    $('signupForm').style.display = tab==='signup' ? 'block' : 'none';
    $('authTitle').textContent    = tab==='login'  ? 'Welcome Back' : 'Create Account';
    $('authSub').textContent      = tab==='login'
      ? 'Sign in to your personal cloud-synced book collection.'
      : 'Create your free account ‚Äî no credit card needed.';
    document.querySelectorAll('.auth-tab').forEach((t,i) =>
      t.classList.toggle('active',(tab==='login'&&i===0)||(tab==='signup'&&i===1))
    );
  };

  // ‚îÄ‚îÄ ERROR MESSAGES ‚îÄ‚îÄ
  function errMsg(msg) {
    const map = {
      'Invalid login credentials':'Incorrect email or password.',
      'Email not confirmed':'Please confirm your email first, then sign in.',
      'User already registered':'An account with this email already exists.',
      'Password should be at least 6':'Password must be at least 6 characters.',
      'Unable to validate email address':'Please enter a valid email address.',
      'For security purposes':'Too many attempts. Please wait a moment.',
    };
    for (const [k,v] of Object.entries(map)) if(msg.includes(k)) return v;
    return msg || 'Something went wrong. Try again.';
  }

  function showMsg(id, msg, type='error') {
    const el=$(id); el.textContent=msg; el.className='auth-msg '+type; el.style.display='block';
    if(type!=='success') setTimeout(()=>el.style.display='none',5000);
  }

  // ‚îÄ‚îÄ SIGN UP ‚îÄ‚îÄ
  window.signup = async () => {
    const username=$('signupUsername').value.trim();
    const email=$('signupEmail').value.trim();
    const pass=$('signupPass').value, pass2=$('signupPass2').value;
    if(!username||!email||!pass||!pass2) return showMsg('signupError','Please fill in all fields.');
    if(username.length<3) return showMsg('signupError','Username must be at least 3 characters.');
    if(!/^[a-zA-Z0-9_]+$/.test(username)) return showMsg('signupError','Username: letters, numbers, underscores only.');
    if(pass!==pass2) return showMsg('signupError','Passwords do not match.');
    $('signupBtn').disabled=true; $('signupBtn').textContent='CREATING...';
    const { error } = await sb.auth.signUp({ email, password:pass, options:{ data:{ username } } });
    $('signupBtn').disabled=false; $('signupBtn').textContent='CREATE ACCOUNT ‚Üí';
    if(error) return showMsg('signupError', errMsg(error.message));
    $('signupError').style.display='none';
    showMsg('signupSuccess','‚úì Account created! Check your email and click the confirmation link, then sign in.','success');
  };

  // ‚îÄ‚îÄ SIGN IN ‚îÄ‚îÄ
  window.login = async () => {
    const email=$('loginEmail').value.trim(), pass=$('loginPass').value;
    if(!email||!pass) return showMsg('loginError','Please fill in all fields.');
    $('loginBtn').disabled=true; $('loginBtn').textContent='SIGNING IN...';
    const { error } = await sb.auth.signInWithPassword({ email, password:pass });
    if(error) { showMsg('loginError', errMsg(error.message)); $('loginBtn').disabled=false; $('loginBtn').textContent='SIGN IN ‚Üí'; }
  };

  // ‚îÄ‚îÄ LOGOUT ‚îÄ‚îÄ
  window.logout = async () => { await sb.auth.signOut(); allBooks=[]; $('booksGrid').innerHTML=''; };

  // ‚îÄ‚îÄ LOAD APP ‚îÄ‚îÄ
  async function loadApp(user) {
    const username = user.user_metadata?.username || user.email.split('@')[0];
    $('authScreen').style.display='none'; $('appScreen').style.display='block';
    $('navUsername').textContent=username;
    $('pageTitle').textContent=username+"'s Library";
    $('footerUser').textContent=username;
    await fetchBooks(user.id);
  }

  // ‚îÄ‚îÄ FETCH BOOKS ‚îÄ‚îÄ
  async function fetchBooks(uid) {
    const { data,error } = await sb.from('books').select('*').eq('user_id',uid).order('added_at',{ascending:false});
    if(error) { showToast('Error loading books.','error'); return; }
    allBooks=data||[]; renderBooks();
  }

  // ‚îÄ‚îÄ ADD BOOK ‚îÄ‚îÄ
  window.addBook = async () => {
    const isbn=$('isbnInput').value.trim().replace(/[-\s]/g,'');
    if(!isbn) return showFeedback('Please enter an ISBN number.','error');
    if(!/^\d{10}(\d{3})?$/.test(isbn)) return showFeedback('Enter a valid 10 or 13-digit ISBN.','error');
    if(allBooks.find(b=>b.isbn===isbn)) return showFeedback('This book is already in your library!','error');
    showFeedback('Looking up book...','loading'); $('addBtn').disabled=true;
    try {
      const res=await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${isbn}&format=json&jscmd=data`);
      const data=await res.json(); const key=`ISBN:${isbn}`;
      if(!data[key]) { showFeedback('Book not found. Check the ISBN and try again.','error'); $('addBtn').disabled=false; return; }
      const info=data[key];
      const book={ user_id:currentUser.id, isbn, title:info.title||'Unknown Title', authors:info.authors?.map(a=>a.name).join(', ')||'Unknown Author', cover:info.cover?.medium||info.cover?.small||null, added_at:new Date().toISOString() };
      const { data:inserted,error } = await sb.from('books').insert([book]).select().single();
      if(error) { showFeedback('Error saving: '+error.message,'error'); $('addBtn').disabled=false; return; }
      allBooks.unshift(inserted); $('isbnInput').value='';
      showFeedback(`"${book.title}" added!`,'success');
      renderBooks(); showToast(`üìö "${book.title}" added!`,'success');
    } catch(e) { showFeedback('Network error. Check your connection.','error'); }
    $('addBtn').disabled=false;
  };

  // ‚îÄ‚îÄ DELETE BOOK ‚îÄ‚îÄ
  window.deleteBook = async (id,title,e) => {
    e.stopPropagation();
    const { error }=await sb.from('books').delete().eq('id',id).eq('user_id',currentUser.id);
    if(error) { showToast('Error removing book.','error'); return; }
    allBooks=allBooks.filter(b=>b.id!==id); renderBooks();
    showToast(`üóëÔ∏è "${title}" removed.`,'error');
  };

  // ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
  function renderBooks(list=null) {
    const books=list??allBooks;
    const grid=$('booksGrid'), empty=$('emptyState'), stats=$('statsRow'), search=$('searchBar');
    $('bookCount').textContent=allBooks.length; $('statTotal').textContent=allBooks.length;
    $('statRecent').textContent=allBooks[0] ? new Date(allBooks[0].added_at).toLocaleDateString('en-IN',{day:'numeric',month:'short'}) : '‚Äî';
    if(allBooks.length===0) {
      grid.style.display='none'; empty.style.display='block'; stats.style.display='none'; search.style.display='none';
      revealObs.observe(empty); return;
    }
    empty.style.display='none'; grid.style.display='grid'; stats.style.display='flex'; search.style.display='block';
    if(books.length===0) { grid.innerHTML=`<p style="color:var(--muted);font-family:'Space Mono',monospace;font-size:0.8rem;grid-column:1/-1">No books match your search.</p>`; return; }
    grid.innerHTML='';
    books.forEach(book => {
      const safeTitle=book.title.replace(/'/g,"\\'").replace(/"/g,'&quot;');
      const card=document.createElement('div'); card.className='book-card';
      card.innerHTML=`
        <button class="book-delete" onclick="deleteBook(${book.id},'${safeTitle}',event)" title="Remove">‚úï</button>
        ${book.cover
          ?`<img class="book-cover" src="${book.cover}" alt="${book.title}" loading="lazy" onerror="this.outerHTML='<div class=\\'book-cover-placeholder\\'>üìò</div>'">`
          :`<div class="book-cover-placeholder">üìò</div>`}
        <div class="book-info">
          <div class="book-title">${book.title}</div>
          <div class="book-author">${book.authors}</div>
          <div class="book-isbn">${book.isbn}</div>
        </div>`;
      grid.appendChild(card);
      // re-attach cursor events for new cards
      card.addEventListener('mouseenter',()=>{ cursor.style.transform='scale(2)'; ring.style.width='56px'; ring.style.height='56px'; ring.style.borderColor='var(--accent2)'; });
      card.addEventListener('mouseleave',()=>{ cursor.style.transform='scale(1)'; ring.style.width='36px'; ring.style.height='36px'; ring.style.borderColor='var(--accent)'; });
    });
  }

  // ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ
  window.filterBooks = () => {
    const q=$('searchBar').value.toLowerCase();
    renderBooks(allBooks.filter(b=>b.title.toLowerCase().includes(q)||b.authors.toLowerCase().includes(q)));
  };

  // ‚îÄ‚îÄ FEEDBACK ‚îÄ‚îÄ
  function showFeedback(msg,type) {
    const el=$('addFeedback');
    el.textContent=type==='loading'?'‚è≥ '+msg:type==='error'?'‚úó '+msg:'‚úì '+msg;
    el.className='add-feedback '+type; el.style.display='block';
    if(type!=='loading') setTimeout(()=>el.style.display='none',4000);
  }

  // ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
  function showToast(msg,type='success') {
    const t=$('toast'); t.textContent=msg; t.className='toast '+type+' show';
    setTimeout(()=>t.className='toast '+type,3200);
  }

  // Enter keys
  document.addEventListener('keydown',e=>{
    if(e.key!=='Enter') return;
    if($('loginForm').style.display!=='none') window.login();
    else if($('signupForm').style.display!=='none') window.signup();
  });
</script>
</body>
</html>
